<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专 转拽 AI 专转</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
        window.MathJax = {
          tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']], // For inline math
            displayMath: [['$$', '$$'], ['\\[', '\\]']] // For display math (centered on new line)
          },
          svg: {
            fontCache: 'global' // Uses a global font cache for faster rendering
          }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; } 
        .math-problem-display p { margin-bottom: 0.5rem; }
        .math-problem-display { font-size: 1.25rem; font-weight: 600; text-align: center; line-height: 1.8; }
        .rtl-text { direction: rtl; text-align: right; }
        
        .chat-message-user { background-color: #DBEAFE; align-self: flex-end; text-align: right; border-radius: 0.75rem 0.75rem 0.25rem 0.75rem; padding: 0.75rem 1rem; margin-bottom: 0.5rem; max-width: 80%; }
        .chat-message-ai { background-color: #eef2ff; align-self: flex-start; text-align: right; border-radius: 0.75rem 0.75rem 0.75rem 0.25rem; padding: 1rem 1.25rem; margin-bottom: 0.5rem; border: 1px solid #c7d2fe; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 1.05em; line-height: 1.6; max-width: 80%; }

        #mathBotToggleContainer { position: fixed; bottom: 2rem; right: 2rem; z-index: 1000; display: flex; flex-direction: column-reverse; align-items: center; }
        #mathBotToggle { width: 4rem; height: 4rem; background-color: #4f46e5; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s ease-in-out; }
        #mathBotToggle:hover { transform: scale(1.1); background-color: #4338ca; }
        #mathBotToggle svg { width: 2rem; height: 2rem; }
        #proactiveTipBubble { background-color: #6366f1; color: white; padding: 0.5rem 1rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06); margin-bottom: 0.5rem; max-width: 250px; font-size: 0.875rem; text-align: center; opacity: 0; transform: translateY(10px) scale(0.95); visibility: hidden; transition: opacity 0.3s ease-out,transform 0.3s ease-out,visibility 0.3s linear; pointer-events: none; }
        #proactiveTipBubble.visible { opacity: 1; transform: translateY(0) scale(1); visibility: visible; }
        #mathBotContainer { position: fixed; bottom: calc(2rem + 4rem + 1rem); right: 2rem; width: 360px; height: 550px; max-height: calc(100vh - 8rem); background-color: white; border-radius: 1rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1),0 10px 10px -5px rgba(0,0,0,0.04); z-index: 999; display: flex; flex-direction: column; overflow: hidden; transform: translateY(100%) scale(0.8); opacity: 0; visibility: hidden; transition: transform 0.3s cubic-bezier(0.68,-0.55,0.27,1.55),opacity 0.3s ease-out,visibility 0.3s linear; }
        #mathBotContainer.expanded { transform: translateY(0) scale(1); opacity: 1; visibility: visible; }
        #chatHeader { background-color: #4f46e5; color: white; padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; border-top-left-radius: 1rem; border-top-right-radius: 1rem; }
        #chatHeader h3 { font-weight: 600; }
        #closeChatButton { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0.25rem; line-height: 1; }
        #closeChatButton:hover { color: #c7d2fe; }
        #chatMessagesDisplay { flex-grow: 1; overflow-y: auto; padding: 1rem; background-color: #f9fafb; }
        #chatInputContainer { border-top: 1px solid #e5e7eb; padding: 0.75rem; background-color: white; display: flex; }
        #chatInputContainer textarea { border-top-left-radius: 0.5rem; border-bottom-left-radius: 0.5rem; }
        #chatInputContainer button { border-top-right-radius: 0.5rem; border-bottom-right-radius: 0.5rem; }
        #pasteZone { border: 2px dashed #cbd5e1; padding: 1rem; text-align: center; color: #64748b; border-radius: 0.5rem; margin-top: 0.5rem; cursor: default; }
        #pasteZone:hover { border-color: #94a3b8; background-color: #f8fafc; }
        
        .top-button { position: absolute; top: 1.5rem; z-index: 50; background-color: #e0e7ff; color: #3730a3; border-radius: 50%; width: 2.5rem; height: 2.5rem; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: background-color 0.2s; }
        .top-button:hover { background-color: #c7d2fe; }
        #settingsButton { left: 1.5rem; }
        #historyButton { left: 4.5rem; } 

        .collapsible-menu { transition: max-height 0.4s ease-out, opacity 0.3s ease-out, margin-bottom 0.4s ease-out; overflow: hidden; max-height: 0; opacity: 0; margin-bottom: 0; }
        .collapsible-menu.expanded { max-height: 1000px; opacity: 1; margin-bottom: 1.5rem; }
        #historyPanelContent { max-height: 300px; overflow-y: auto; }
        #aiRecommendationsContent { max-height: 200px; overflow-y: auto; background-color: #f3e8ff; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; }

        #whiteboardModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        #whiteboardModal.visible { opacity: 1; visibility: visible; }
        #whiteboardContainer { background-color: white; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: flex; flex-direction: column; width: 90%; max-width: 800px; height: 80%; max-height: 600px; }
        #drawingBoard { border: 1px solid #ccc; cursor: crosshair; touch-action: none; width: 100%; height: 100%; flex-grow: 1; }
        #whiteboardControls { margin-top: 0.5rem; display: flex; justify-content: space-around; gap: 0.5rem; padding: 0.5rem 0; }
        #whiteboardControls button { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: background-color 0.2s; }
        #openWhiteboardButton { display: inline-flex; align-items: center; gap: 0.5rem; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 sm:p-8 flex flex-col items-center font-sans text-gray-800">

    <svg width="0" height="0" style="position:absolute; overflow:hidden;">
        <symbol id="graph-hanion-II" viewBox="0 0 400 250"> <rect x="0" y="0" width="400" height="250" fill="#FFFFFF" stroke="#000" stroke-width="1"/> <line x1="50" y1="220" x2="380" y2="220" stroke="#000" stroke-width="1.5"/> <line x1="50" y1="220" x2="50" y2="20" stroke="#000" stroke-width="1.5"/> <text x="50" y="235" font-family="sans-serif" font-size="10" text-anchor="middle">0</text> <text x="80" y="235" font-family="sans-serif" font-size="10" text-anchor="middle">1</text> <text x="110" y="235" font-family="sans-serif" font-size="10" text-anchor="middle">2</text> <text x="140" y="235" font-family="sans-serif" font-size="10" text-anchor="middle">3</text> <text x="170" y="235" font-family="sans-serif" font-size="10" text-anchor="middle">4</text> <text x="200" y="235" font-family="sans-serif" font-size="10" text-anchor="middle">5</text> <text x="230" y="235" font-family="sans-serif" font-size="10" text-anchor="middle">6</text> <text x="260" y="235" font-family="sans-serif" font-size="10" text-anchor="middle">7</text> <text x="290" y="235" font-family="sans-serif" font-size="10" text-anchor="middle">8</text> <text x="320" y="235" font-family="sans-serif" font-size="10" text-anchor="middle">9</text> <text x="350" y="235" font-family="sans-serif" font-size="10" text-anchor="middle">10</text> <text x="380" y="235" font-family="sans-serif" font-size="10" text-anchor="middle">11</text> <text x="380" y="210" font-family="sans-serif" font-size="12" text-anchor="end">  (砖注转)</text> <text x="40" y="205" font-family="sans-serif" font-size="10" text-anchor="end">15</text> <text x="40" y="175" font-family="sans-serif" font-size="10" text-anchor="end">30</text> <text x="40" y="145" font-family="sans-serif" font-size="10" text-anchor="end">45</text> <text x="40" y="115" font-family="sans-serif" font-size="10" text-anchor="end">60</text> <text x="40" y="85" font-family="sans-serif" font-size="10" text-anchor="end">75</text> <text x="20" y="30" font-family="sans-serif" font-size="12" text-anchor="end">转砖 (砖拽)</text> <line x1="50" y1="205" x2="140" y2="205" stroke="blue" stroke-width="2"/> <circle cx="50" cy="205" r="3" fill="black"/> <circle cx="140" cy="205" r="3" fill="black"/> <circle cx="140" cy="175" r="3" fill="white" stroke="blue" stroke-width="1.5"/> <line x1="140" y1="175" x2="260" y2="175" stroke="blue" stroke-width="2"/> <circle cx="140" cy="175" r="3" fill="black"/> <circle cx="260" cy="175" r="3" fill="black"/> <circle cx="260" cy="85" r="3" fill="white" stroke="blue" stroke-width="1.5"/> <line x1="260" y1="85" x2="380" y2="85" stroke="blue" stroke-width="2"/> <circle cx="260" cy="85" r="3" fill="black"/> <circle cx="380" cy="85" r="3" fill="black"/> </symbol>
        <symbol id="拽转-ABCD" viewBox="0 0 400 250"> <rect x="0" y="0" width="400" height="250" fill="#FFFFFF" stroke="#000" stroke-width="1"/> <line x1="50" y1="220" x2="380" y2="220" stroke="#000" stroke-width="1.5"/> <line x1="50" y1="220" x2="50" y2="20" stroke="#000" stroke-width="1.5"/> <polygon points="70,220 120,80 320,80 270,220" fill="none" stroke="black" stroke-width="2"/> <line x1="70" y1="220" x2="320" y1="80" stroke="gray" stroke-dasharray="5,5" stroke-width="1.5"/> <text x="60" y="230" font-family="sans-serif" font-size="14">A</text> <text x="110" y="70" font-family="sans-serif" font-size="14">B</text> <text x="330" y="70" font-family="sans-serif" font-size="14">C</text> <text x="260" y="230" font-family="sans-serif" font-size="14">D</text> <text x="40" y="30" font-family="sans-serif" font-size="12">y</text> <text x="390" y="210" font-family="sans-serif" font-size="12">x</text> </symbol>
        <symbol id="砖砖-砖-砖拽" viewBox="0 0 400 250"> <rect x="0" y="0" width="400" height="250" fill="#FFFFFF" stroke="#000" stroke-width="1"/> <polygon points="200,50 100,200 300,200" fill="none" stroke="black" stroke-width="2"/> <line x1="100" y1="200" x2="250" y1="125" stroke="gray" stroke-dasharray="5,5" stroke-width="1.5"/> <rect x="245" y="125" width="8" height="8" stroke="black" fill="none" stroke-width="1"/> <text x="195" y="40" font-family="sans-serif" font-size="14">A</text> <text x="90" y="215" font-family="sans-serif" font-size="14">B</text> <text x="310" y="215" font-family="sans-serif" font-size="14">C</text> <text x="255" y="115" font-family="sans-serif" font-size="14">D</text> <path d="M290 200 A10 10 0 0 0 290 190 L300 200 Z" fill="none" stroke="black" stroke-width="1"/> <text x="285" y="195" font-family="sans-serif" font-size="10">65掳</text> </symbol>
        <symbol id="驻专" viewBox="0 0 400 250"> <rect x="0" y="0" width="400" height="250" fill="#FFFFFF" stroke="#000" stroke-width="1"/> <line x1="50" y1="220" x2="380" y2="220" stroke="#000" stroke-width="1.5"/> <line x1="50" y1="220" x2="50" y2="20" stroke="#000" stroke-width="1.5"/> <path d="M 125 220 Q 225 60 325 220" fill="none" stroke="blue" stroke-width="2"/> <circle cx="125" cy="220" r="3" fill="black"/> <text x="120" y="235" font-family="sans-serif" font-size="14">A</text> <circle cx="325" cy="220" r="3" fill="black"/> <text x="320" y="235" font-family="sans-serif" font-size="14">B</text> <circle cx="225" cy="60" r="3" fill="black"/> <text x="220" y="50" font-family="sans-serif" font-size="14">C</text> <text x="40" y="30" font-family="sans-serif" font-size="12">y</text> <text x="390" y="210" font-family="sans-serif" font-size="12">x</text> </symbol>
        <symbol id="parabola-horizontal-line-2024B" viewBox="0 0 400 250"> <rect x="0" y="0" width="400" height="250" fill="#FFFFFF" stroke="#000" stroke-width="1"/> <line x1="50" y1="220" x2="380" y2="220" stroke="#000" stroke-width="1.5"/> <line x1="50" y1="220" x2="50" y2="20" stroke="#000" stroke-width="1.5"/> <path d="M 50 180 C 100 50, 200 20, 300 50 S 350 80, 380 180" fill="none" stroke="blue" stroke-width="2"/> <line x1="50" y1="100" x2="380" y2="100" stroke="gray" stroke-width="1.5"/> <circle cx="100" cy="100" r="3" fill="black"/> <text x="95" y="90" font-family="sans-serif" font-size="14">A</text> <circle cx="300" cy="100" r="3" fill="black"/> <text x="295" y="90" font-family="sans-serif" font-size="14">B</text> <circle cx="200" cy="200" r="3" fill="black"/> <text x="195" y="215" font-family="sans-serif" font-size="14">D</text> <line x1="200" y1="100" x2="200" y1="200" stroke="gray" stroke-dasharray="3,3" stroke-width="1"/> <rect x="195" y="100" width="8" height="8" stroke="black" fill="none" stroke-width="1"/> <text x="40" y="30" font-family="sans-serif" font-size="12">y</text> <text x="390" y="210" font-family="sans-serif" font-size="12">x</text> </symbol>
        </svg>

    <div class="w-full max-w-3xl bg-white rounded-xl shadow-lg p-6 sm:p-8 border border-gray-200 rtl-text mb-24 relative"> 
        <button id="settingsButton" class="top-button" aria-label="专转">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.646.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 1.905c-.007.379.137.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.333.183-.582.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.759 6.759 0 010-1.905c.007-.379-.137-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
        </button>
        <button id="historyButton" class="top-button" aria-label="住专 转">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
        </button>

        <h1 class="text-3xl sm:text-4xl font-bold text-center text-indigo-700 mb-6">专 转拽 AI 专转</h1>

        <div id="settingsMenu" class="collapsible-menu">
             <div class="bg-gray-100 rounded-lg p-5 border border-gray-300">
                <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-3 text-center">专转</h2>
                <p class="text-sm text-gray-600 mb-1">驻转 API 砖 Gemini:</p>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="password" id="apiKeyInput" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder=" 转 驻转 -API ...">
                    <button id="saveApiKeyButton" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">砖专 驻转 API</button>
                </div>
                <p id="apiKeyStatus" class="mt-2 text-sm text-center text-green-700 hidden"></p>
            </div>
        </div>
        <div id="historyMenu" class="collapsible-menu">
            <div class="bg-teal-50 rounded-lg p-5 border border-teal-200">
                 <h2 class="text-xl sm:text-2xl font-semibold text-teal-800 mb-3 text-center">住专 转</h2>
                 <div id="historyPanelContent" class="bg-white p-3 rounded border border-gray-200 mb-4 text-sm">
                     住专 注.
                 </div>
                 <div id="aiRecommendationsContent" class="hidden text-sm"></div>
                 <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                    <button id="exportCsvButton" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">爪 -CSV</button>
                    <button id="exportJsonButton" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">爪 -JSON</button>
                    <button id="getRecommendationsButton" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">拽 爪转</button>
                 </div>
            </div>
        </div>

        <div class="bg-gray-100 rounded-lg p-5 mb-6 border border-gray-300">
            <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-3 text-center">
                专 砖转 专转
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                <div>
                    <label for="moduleSelect" class="block text-sm font-medium text-gray-700 mb-1">
                        :
                    </label>
                    <select id="moduleSelect" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </select>
                </div>
                <div>
                    <label for="yearSelect" class="block text-sm font-medium text-gray-700 mb-1">
                        砖:
                    </label>
                    <select id="yearSelect" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </select>
                </div>
                <div>
                    <label for="questionSelect" class="block text-sm font-medium text-gray-700 mb-1">
                        砖:
                    </label>
                    <select id="questionSelect" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </select>
                </div>
            </div>
            <button id="loadProblemButton" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                注 砖 专转
            </button>
        </div>

        <div id="problemDisplaySection" class="bg-blue-50 rounded-lg p-5 mb-6 border border-blue-200">
            </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div id="initialAnswerSection">
                <label for="studentAnswer" class="block text-lg font-medium text-gray-700 mb-2">转砖 砖:</label>
                <textarea id="studentAnswer" class="w-full p-3 border border-gray-300 rounded-lg min-h-[160px]" rows="5" placeholder="拽 转 转砖转 转 砖 驻转专 ..."></textarea>
                 <button id="openWhiteboardButton" class="mt-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-3 rounded-lg text-sm inline-flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>
                    驻转  拽
                </button>
            </div>
            <div id="imageUploadSection">
                <label for="imageUpload" class="block text-lg font-medium text-gray-700 mb-2">注 注转 :</label>
                <input type="file" id="imageUpload" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                <div id="pasteZone" class="mt-2"> 拽 爪 住  (Ctrl+V)</div>
                <p id="selectedImageName" class="mt-2 text-sm text-gray-600"></p>
                 <div class="mt-4">
                    <button id="getHintButton" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition w-full sm:w-auto">
                         拽 专
                    </button>
                    <div id="hintDisplay" class="mt-3 p-3 bg-orange-100 text-orange-800 rounded-lg hidden text-center"></div>
                </div>
            </div>
        </div>
         <button id="checkAnswerButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg mb-6">拽 转砖 / 拽 砖</button>
        
        <div id="checkAnswerResultDisplay" class="p-4 rounded-lg mb-6 text-center font-semibold text-lg hidden">
            </div>
        <button id="acknowledgeFeedbackButton" class="hidden mt-2 w-full sm:w-auto mx-auto bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">转, 砖</button>

        <div id="stepByStepSection" class="bg-yellow-50 rounded-lg p-5 mb-6 border border-yellow-200 hidden">
            <h2 class="text-xl sm:text-2xl font-semibold text-yellow-800 mb-3 text-center">砖 <span id="currentStepNumber">1</span></h2>
            <div id="currentSubProblemQuestion" class="math-problem-display text-xl font-semibold text-center mb-4">
                 </div>
            <label for="currentSubProblemAnswer" class="block text-lg font-medium text-gray-700 mb-2">转砖转:</label>
            <textarea id="currentSubProblemAnswer" class="w-full p-3 border border-gray-300 rounded-lg min-h-[60px]" rows="3" placeholder="拽 转 转砖转 砖 ..."></textarea>
            <button id="checkSubStepButton" class="mt-4 w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg">拽 砖</button>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
            <button id="simplifyProblemButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">驻砖 注</button>
            <button id="makeHarderProblemButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg">驻 拽砖 转专</button>
        </div>
        <div id="loadingIndicator" class="flex items-center justify-center mb-4 text-indigo-600 hidden"> 
            <svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24"> <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle> <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path> </svg> 注... 
        </div>
        <div id="errorMessageDisplay" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4 hidden" role="alert"> 
            <strong class="font-bold">砖!</strong> <span id="errorMessageText" class="block sm:inline"></span> 
        </div>
        <div id="aiFeedbackDisplay" class="bg-purple-50 rounded-lg p-5 border border-purple-200 mt-6 hidden"> 
            <h2 class="text-xl sm:text-2xl font-semibold text-purple-800 mb-3 text-center">砖 AI</h2> 
            <div id="aiFeedbackContent" class="text-gray-700 leading-relaxed">
                 </div> 
        </div>
    </div>

    <div id="mathBotToggleContainer">
        <div id="proactiveTipBubble">
             </div>
        <div id="mathBotToggle"> 
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5h0v-1.5m0 0h0m0 0H9.75m10.125 0a9.75 9.75 0 01-9.75 9.75c-4.418 0-8.268-2.903-9.5-7.036m19 0c-.162 2.097-.735 4.034-1.595 5.682A9.723 9.723 0 0112 21.75c-2.602 0-4.967-.992-6.797-2.64S2.25 14.602 2.25 12c0-1.63.396-3.173 1.099-4.518M7.5 10.5h.008v.008H7.5V10.5zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm4.125 4.5h.008v.008h-.008V15zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm4.125-4.5h.008v.008h-.008V10.5zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
            </svg> 
        </div>
        <p class="text-xs text-gray-500 mt-1 text-center">砖 转  "住专..."</p>
    </div>

    <div id="mathBotContainer">
        <div id="chatHeader"> <h3>爪' 转 注 AI</h3> <button id="closeChatButton" aria-label="住专 爪'">&times;</button> </div>
        <div id="chatMessagesDisplay" class="flex flex-col h-full bg-white border-gray-300 p-4 overflow-y-auto">
             </div>
        <div id="chatInputContainer" class="flex p-3 bg-gray-100 border-t border-gray-200">
            <textarea id="chatInput" class="flex-grow p-3 border border-gray-300 rounded-l-lg" rows="2" placeholder="砖 砖 转转..."></textarea>
            <button id="sendChatMessageButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-r-lg">砖</button>
        </div>
         <p class="text-xs text-gray-500 p-2 text-center bg-gray-100">砖转砖 爪' 砖转 转, 住专 ("住专...")  注专.</p>
    </div>

    <div id="whiteboardModal">
        <div id="whiteboardContainer">
            <canvas id="drawingBoard"></canvas>
            <div id="whiteboardControls">
                <button id="saveWhiteboardButton" class="bg-green-500 hover:bg-green-600 text-white">砖专 拽抓 砖转砖</button>
                <button id="clearWhiteboardButton" class="bg-yellow-500 hover:bg-yellow-600 text-white">拽 </button>
                <button id="closeWhiteboardButton" class="bg-red-500 hover:bg-red-600 text-white">住专 </button>
            </div>
        </div>
    </div>

    <script>
        // Global state variables
        let geminiApiKey = '';
        let currentProblem = null;
        // let isLoading = false; // Managed by UI classes
        // let errorMessage = ''; // Managed by UI elements
        let checkAnswerResult = null; 

        let isInStepByStepMode = false;
        let currentStepIndex = 0;
        let stepByStepHistory = []; 
        let currentSubProblemQuestionText = ''; // Renamed from currentSubProblemQuestion for clarity
        
        let chatMessages = []; 
        // let isChatLoading = false; // Managed by button disabling
        let lastMathTopic = '转拽'; 
        let userHistory = []; 

        // DOM Elements - Declared with let, will be assigned in window.onload
        let settingsButton, historyButton, settingsMenu, historyMenu, historyPanelContent,
            exportCsvButton, exportJsonButton, getRecommendationsButton, aiRecommendationsContent,
            getHintButton, hintDisplay, apiKeyInput, saveApiKeyButton, apiKeyStatus,
            moduleSelect, yearSelect, questionSelect, loadProblemButton, problemDisplaySection,
            studentAnswerInput, checkAnswerButton, checkAnswerResultDisplay, acknowledgeFeedbackButton,
            stepByStepSection, currentStepNumberSpan, currentSubProblemQuestionDiv,
            currentSubProblemAnswerInput, checkSubStepButton, imageUploadInput, pasteZone,
            selectedImageName, simplifyProblemButton, makeHarderProblemButton, loadingIndicator,
            errorMessageDisplay, errorMessageText, aiFeedbackDisplay, aiFeedbackContent,
            mathBotToggleContainer, mathBotToggle, proactiveTipBubble, mathBotContainer,
            closeChatButton, chatMessagesDisplay, chatInput, sendChatMessageButton,
            openWhiteboardButton, whiteboardModal, drawingBoard, saveWhiteboardButton,
            clearWhiteboardButton, closeWhiteboardButton, whiteboardCtx,
            isDrawingOnWhiteboard = false, lastX, lastY;


        const GEMINI_MODEL_NAME = 'gemini-1.5-flash-latest'; 
        
        // --- BAGRUT QUESTIONS DATA ---
        // This structure is based on the PDF filenames provided by the user.
        // The user needs to manually transcribe all questions and answers in LaTeX.
        const bagrutQuestionsData = {
            '35182': { // 砖 专砖
                '2025': [ // 专祝 转砖驻" (Based on 砖-35182 (1)专祝2025.pdf and 砖-35182拽抓01.pdf)
                    { 
                        id: '35182-2025-1', 
                        question: "砖专转 砖  转   砖专转 砖  志 1,740 砖拽. 砖专转 砖  注转 志15%, 砖专转 砖  砖专  砖. 专 注 转 砖专转 砖  砖 砖专转 砖 . 住  $x$ 转 砖专转 砖  驻 注. . 注 爪注转 $x$ 转 砖专转 砖 . . 爪 转 砖专转 砖  驻 注.", 
                        answer: ". $x+1740$  . 11600 砖拽", // Example answer, ensure correct LaTeX
                        topic: "专 - 注转 转", 
                        difficulty: "拽", 
                        mikud: false, 
                        imageUrl: null 
                    },
                    {
                        id: '35182-2025-2',
                        question: "  专 砖专  转 专 注专 转 驻专转.    砖 :  I   II.  I 转砖  转  ,  60 砖拽 .  II 转砖 转  , 驻 砖注转. 专祝 砖驻 转专 转 拽砖专  住驻专 砖注转   转砖 注专   II. (专 住专  拽专转). .  专砖  专 砖专  II 砖注 9:00 拽专, 注 转  砖注 13:00 爪专.  砖 专 砖专 注专   专砖? .  砖 转 专 砖专 砖专 专 注专 8 砖注转,    转  砖 转砖 注专  砖 8 砖注转  转专.  砖 专 砖专 注专  转? .  砖注转  转专  专 砖专 转,  砖  50 砖拽 ?",
                        answer: ". 45 砖拽 . 60 砖拽 . 6 砖注转",
                        topic: "驻拽爪转 专驻",
                        difficulty: "",
                        mikud: false,
                        imageUrl: "#graph-hanion-II" // Using SVG symbol ID from your HTML
                    },
                     {
                        id: '35182-2025-3',
                        question: "住专 砖转 专 砖砖  4, 专 砖  9. . (1) 爪 转 驻专砖 住专. (2) 爪 转 专 专砖 住专. 专 专 住专  39. . 爪 转 住驻专 专 住专. . 爪 转 住  专 住专.",
                        answer: ". (1) $d=2.5$ (2) $a_1=-1$ . $n=16$ . $S_n=304$",
                        topic: "住专转 砖转",
                        difficulty: "",
                        mikud: false,
                        imageUrl: null
                    },
                ],
                '2024': [ // 拽抓 转砖驻"
                    { 
                        id: '35182-2024拽-1', // From 砖-35182 (1).pdf
                        question: "转 专 住转 专 砖 砖  志 6 住转  3,980 砖拽, 专 砖 砖  志2 住转  2,860 砖拽. . 砖 转 专 砖 砖  转 专 砖 住 . .  转  注转 转 专 砖 砖 志 10% 转转  砖 15% 注 专 砖 住.  拽 转  砖  志 8 住转 专 砖 专. 爪  砖  住  注专 专 砖拽.", 
                        answer: ". 砖: 2580 砖拽, 住: 230 砖拽 . 4412 砖拽", 
                        topic: "专 - 注专转 砖转", 
                        difficulty: "", 
                        mikud: false, 
                        imageUrl: null 
                    },
                     { 
                        id: '35182-2024拽-1', // 拽抓 注  from 砖-35182-1 (2).pdf
                        question: "专 专住 住   34 砖拽 专 志 20 砖拽 .  注 拽爪 砖 50 拽专,  专 . 注转 砖  专住 住 砖 拽爪转 拽专 转 1,182 砖拽 住 . . 爪  专  拽爪. . 注转 转砖 拽驻 拽 拽爪  砖 18% 注专 专住 住   (专 砖 专住 专  砖转). 爪  砖 拽爪转 拽专 住  注专 专住 住.", 
                        answer: ". 13 专 . 1044.4 砖拽", 
                        topic: "专 - 注转 转", 
                        difficulty: "", 
                        mikud: false, 
                        imageUrl: null 
                    },
                ]
            },
            '35381': { // 砖 砖
                '2025': [ // 专祝 转砖驻" (from 35381-砖专祝2025.pdf)
                    { 
                        id: '35381-2025-1', 
                        question: "转 驻专 砖砖转 $y=-4x^{2}+28x-33$. A  B  拽转 转 砖 驻专 注 爪专 志 $x$, 转专 住专. . 爪 转 砖注专 拽转 A 志B. 拽 C  拽拽 驻专. . 爪 转 砖注专 拽 C. . 砖 转 砖 砖砖 ABC. . (1) 转 注专 砖 砖 $x$ 拽 砖 驻专 砖转. (2) 爪 转 砖注专 志 $y$ 砖 拽 .", 
                        answer: ". $A(1.5,0), B(5.5,0)$ . $C(3.5,16)$ . 32 \"专 . (1)  $x=0$ (2) $y=-33$", 
                        topic: "专 - 驻专", 
                        difficulty: "", 
                        mikud: false, 
                        imageUrl: "#驻专" 
                    },
                ],
                '2024': [ // 拽抓 转砖驻" 注  (from 砖-35381-2.pdf)
                     { 
                        id: '35381-2024拽-1', 
                        question: "转 驻专 砖砖转 $y=x^{2}-6x$. 砖专 $y=16$ 转 转 驻专 拽转 $B\\text{  } A$, 转专 住专 砖驻. . 爪 转 砖注专 拽转 $A \\text{  } B$. 拽 D  拽拽 驻专. . 爪 转 砖注专 拽 D. .  专  爪注 AB 砖砖 ABD ? . 爪 转 砖 砖砖 ABD.", 
                        answer: ". $A(-2,16), B(8,16)$ . $D(3,-9)$ . 25 . 125 \"专", 
                        topic: "专 - 驻专", 
                        difficulty: "", 
                        mikud: false, 
                        imageUrl: "#parabola-horizontal-line-2024B"},
                ]
            },
            '35382': { // 砖 砖砖
                '2025': [ // 专祝 转砖驻" (from 砖-35382专祝2025.pdf and 砖-35382拽抓2025.pdf)
                    { 
                        id: '35382-2025-1', 
                        question: "转  住转 专 砖 注  - 72 砖拽  专 砖 爪. 转 专 注 爪注 砖 15%  注 专 砖 爪 (专 砖 注  砖转). 专 砖 爪 转 爪注 砖 注   175.6 砖拽 住 . . (1) 爪 转 专 砖 爪 驻 . (2) 爪 转 专 砖 爪 爪注. . 拽专转  砖 砖转 \", 拽转 专转 转 60 驻专: 拽 注 砖专 爪转 爪注.  砖 4,383.6 砖拽 住 . 爪 转 住驻专 爪转 砖拽转 专转. .  拽 转 4 注. 砖专 注  拽驻  砖, 转专专  砖   注 专 砖 注,  砖 专 注.  砖 448 砖拽 住 . 爪 转   砖拽  注 专 注.", 
                        answer: ". (1) 68 砖拽 (2) 57.8 砖拽 . 36 爪转 . 20%", 
                        topic: "专 - 注转 转 ", 
                        difficulty: "", 
                        mikud: false, 
                        imageUrl: null 
                    },
                ],
                '2024': [ // 拽抓 转砖驻"
                    { 
                        id: '35382-2024拽-1', // from 砖-35382.pdf
                        question: "专转 住注转 爪注 转 驻砖 转 住  . 专 砖 转 驻砖 专转 住注转  3,760 砖拽.   专    志 35% 专 住. . 爪  专 住 转 驻砖 专 . . 住, 住 住注转,   转 驻砖 专转 住注转.  拽  砖 15% 注 专 住  转 转 驻砖 砖 (专    砖转).  砖 住 注专 转 驻砖 转 专 ? . ,   住 住注转,  转 驻砖 专转 住注转 专转.  砖 4,400 砖拽 注专  转 转 驻砖 砖. 住驻专 转 砖 住  志32 住驻专 转 砖 . 住 砖砖 住 注专  转 砖 砖 住 砖砖  注专  转 砖.  转 驻砖  ?", 
                        answer: ". 1600 砖拽 . 3520 砖拽 . 40 转", 
                        topic: "专 -  注转 转", 
                        difficulty: "拽砖", 
                        mikud: false, 
                        imageUrl: null 
                    },
                     { 
                        id: '35382-2024拽-1', // 拽抓 注  from 砖-35382-1.pdf
                        question: "专 砖 专住 住 专 注专 专  志 9 砖拽  专 砖 专住 住 注专 . 专 拽转 4 专住 住 专 志 17 专住 住 . 住  $x$ 转 专 砖 专住 住 . . 注 爪注转 $x$ 转 专  砖砖 专 注专 专住 住 专. . 驻专 拽   专住 住 专.  拽 7 专住 住 专 志 30 专住 住 . 驻专 拽  砖 15% 注 专 砖 专住 住  (专 砖 专住 住 专  砖转). 住  砖砖 专 驻专  注专  专住  2,399.5 砖拽. 爪 转 $x$. . 爪    转专 住 砖砖 驻专 注专  专住 砖拽  住 砖砖 专 注专  专住 砖拽转 (转砖转 专砖 砖转 住驻专转 专 拽 注砖专转).", 
                        answer: ". $21x+36$ . $x=35$ 砖拽 . 50.59%", 
                        topic: "专 - 注转 转", 
                        difficulty: "拽砖", 
                        mikud: false, 
                        imageUrl: null 
                    },
                ]
            }
        };
        
        // --- History Management ---
        function loadUserHistory() { /* ... same as previous working version ... */ }
        function saveUserHistory() { /* ... same as previous working version ... */ }
        function addHistoryEntry(problemId, questionText, isCorrect, usedStepByStep, typedAnswer = "") { /* ... same as previous working version ... */ }
        function displayUserHistory() { /* ... same as previous working version ... */ }

        // --- Export Functions ---
        function downloadData(filename, data, type) { /* ... same as previous working version ... */ }
        function exportAsCsv() { /* ... same as previous working version ... */ }
        function exportAsJson() { /* ... same as previous working version ... */ }
        
        // --- AI Recommendations ---
        async function getAIRecommendations() { /* ... same as previous working version ... */ }

        // --- Utility Functions (Continued) ---
        function showLoading(show) { if(loadingIndicator) loadingIndicator.classList.toggle('hidden', !show); }
        function showErrorMessage(message) { if(errorMessageText && errorMessageDisplay) { errorMessageText.textContent = message; errorMessageDisplay.classList.remove('hidden'); }}
        function hideErrorMessage() { if(errorMessageDisplay) errorMessageDisplay.classList.add('hidden'); if(errorMessageText) errorMessageText.textContent = ''; }
        
        function resetUIState() { /* ... same as previous working version ... */ }

        // --- API Key & Settings ---
        function toggleSettingsMenu() { if(settingsMenu) settingsMenu.classList.toggle('expanded'); if(historyMenu && historyMenu.classList.contains('expanded')) historyMenu.classList.remove('expanded'); }
        function toggleHistoryMenu() { if(historyMenu) historyMenu.classList.toggle('expanded'); if(settingsMenu && settingsMenu.classList.contains('expanded')) settingsMenu.classList.remove('expanded');} 
        function loadApiKey() { /* ... same as previous working version ... */ }
        function saveApiKey() { /* ... same as previous working version ... */ }

        // --- Dropdowns ---
        function populateDropdowns() {
            if (!moduleSelect) return;
            moduleSelect.innerHTML = '';
            const modulesInData = Object.keys(bagrutQuestionsData).sort();
            if (modulesInData.length === 0) {
                const option = document.createElement('option');
                option.value = ""; option.textContent = "  ";
                moduleSelect.appendChild(option);
                moduleSelect.disabled = true;
                if(yearSelect) yearSelect.disabled = true;
                if(questionSelect) questionSelect.disabled = true;
                if(loadProblemButton) loadProblemButton.disabled = true;
                if(problemDisplaySection) problemDisplaySection.innerHTML = '<p class="text-center text-gray-500"> 住祝 砖转 -bagrutQuestionsData.</p>';
                return;
            }
            moduleSelect.disabled = false;
            if(loadProblemButton) loadProblemButton.disabled = false;

            modulesInData.forEach(module => { 
                const option = document.createElement('option'); option.value = module; option.textContent = `砖 ${module}`; moduleSelect.appendChild(option);
            });
            moduleSelect.value = modulesInData[0]; 
            populateYears();
        }
        function populateYears() {
            if (!yearSelect || !moduleSelect) return;
            yearSelect.innerHTML = '';
            const selectedModule = moduleSelect.value;
            if (!selectedModule || !bagrutQuestionsData[selectedModule]) {
                 const option = document.createElement('option');
                option.value = ""; option.textContent = "专  转";
                yearSelect.appendChild(option);
                yearSelect.disabled = true;
                if(questionSelect) questionSelect.disabled = true;
                return;
            }
            yearSelect.disabled = false;

            const years = Object.keys(bagrutQuestionsData[selectedModule] || {}).sort((a, b) => parseInt(b) - parseInt(a)); 
            if (years.length === 0) {
                const option = document.createElement('option');
                option.value = ""; option.textContent = " 砖  ";
                yearSelect.appendChild(option);
                yearSelect.disabled = true;
                if(questionSelect) questionSelect.disabled = true;
                return;
            }

            years.forEach(year => {
                const option = document.createElement('option'); option.value = year; option.textContent = year; yearSelect.appendChild(option);
            });
            yearSelect.value = years[0];
            populateQuestions(); 
        }
        function populateQuestions() {
            if (!questionSelect || !moduleSelect || !yearSelect) return;
            questionSelect.innerHTML = '';
            const selectedModuleVal = moduleSelect.value;
            const selectedYearVal = yearSelect.value;
            
            if (!selectedModuleVal || !selectedYearVal || !bagrutQuestionsData[selectedModuleVal] || !bagrutQuestionsData[selectedModuleVal][selectedYearVal]) {
                const option = document.createElement('option');
                option.value = ""; option.textContent = "专 砖 转";
                questionSelect.appendChild(option);
                questionSelect.disabled = true;
                return;
            }
            
            const questionsForYear = bagrutQuestionsData[selectedModuleVal][selectedYearVal] || [];
            
            if (questionsForYear.length > 0) {
                questionSelect.disabled = false;
                questionsForYear.forEach((q, index) => {
                    const option = document.createElement('option'); 
                    option.value = (index + 1).toString(); 
                    option.textContent = `砖 ${index + 1}`; 
                    questionSelect.appendChild(option);
                });
                questionSelect.value = "1"; 
            } else {
                const option = document.createElement('option');
                option.value = "0";
                option.textContent = " 砖转 转";
                questionSelect.appendChild(option);
                questionSelect.disabled = true;
            }
        }
        
        // --- Problem Loading ---
        function loadProblemFromSelection() {
            resetUIState(); 
            showLoading(true);
            if (!moduleSelect || !yearSelect || !questionSelect || !problemDisplaySection) {
                 showLoading(false); 
                 console.error("Dropdowns or problem display not found for loading problem.");
                 return;
            }
            const module = moduleSelect.value;
            const year = yearSelect.value;
            const questionNum = parseInt(questionSelect.value);

            if (!module || !year || isNaN(questionNum) || questionNum === 0) {
                problemDisplaySection.innerHTML = `<div class="bg-yellow-100 text-yellow-800 p-4 rounded-lg text-center"> 专 , 砖 砖.</div>`;
                currentProblem = null;
                showLoading(false);
                return;
            }

            const problemData = bagrutQuestionsData[module]?.[year]?.[questionNum - 1];
            if (problemData) {
                currentProblem = { ...problemData }; 
                lastMathTopic = currentProblem.topic || '转拽'; // Update lastMathTopic
                let problemHtml = `
                    <h2 class="text-xl sm:text-2xl font-semibold text-blue-800 mb-3 text-center">
                        砖 ${questionNum} (${currentProblem.difficulty || ' 注'}) ${currentProblem.mikud ? '(拽)' : ''}
                    </h2>
                    <div class="math-problem-display text-xl font-semibold text-center leading-relaxed">
                        ${currentProblem.question} 
                    </div>
                `; 
                if (currentProblem.imageUrl && currentProblem.imageUrl.startsWith("#")) { 
                    problemHtml += `
                        <div class="mt-4 text-center">
                            <svg width="300" height="200" class="mx-auto rounded-lg shadow-md max-w-full h-auto">
                                <use href="${currentProblem.imageUrl}"></use>
                            </svg>
                            <p class="text-sm text-gray-600 mt-2">( 注 转专砖 拽专 砖 专转 注 拽 )</p>
                        </div>`;
                } else if (currentProblem.imageUrl) { 
                     problemHtml += `
                        <div class="mt-4 text-center">
                            <img src="${currentProblem.imageUrl}" alt="转专砖 砖" class="mx-auto rounded-lg shadow-md max-w-full h-auto" onerror="this.onerror=null;this.src='https://placehold.co/400x250/cccccc/000000?text=转专砖++'; this.alt='转专砖  ';">
                            <p class="text-sm text-gray-600 mt-2">( 注 转专砖 拽专 砖 专转 注 拽 )</p>
                        </div>`;
                }
                problemDisplaySection.innerHTML = problemHtml;
                if (window.MathJax && MathJax.typesetPromise) { 
                    MathJax.typesetPromise([problemDisplaySection]).catch((err) => console.error('MathJax typesetting error:', err));
                }
                triggerProactiveTip(); 
            } else { 
                currentProblem = null;
                problemDisplaySection.innerHTML = `<div class="bg-yellow-100 text-yellow-800 p-4 rounded-lg text-center"> 爪 砖 注专 专 转.</div>`;
             }
            showLoading(false);
        }
        
        // --- Gemini API Call ---
        async function callGeminiAPI(promptText, isChatContext = false) { /* ... same as previous working version ... */ }

        // --- Hint System ---
        async function getHint() { /* ... same as previous working version ... MathJax call needed here too */ }

        // --- Answer Processing ---
        async function processStudentInput() { /* ... same as previous working version ... MathJax call needed for feedback display ... */ }

        // --- Step-by-Step Guidance ---
        async function startStepByStepGuidance() { /* ... same as previous working version ... MathJax call needed for sub-problem ... */ }
        function extractContent(text, startMarker, endMarker) { /* ... same as previous working version ... */ }
        async function checkSubStepAnswer() { /* ... same as previous working version ... MathJax call needed for feedback ... */ }
        function handleNextAfterSubStepFeedback(aiResponseText, lastUserSubStepAnswer) { /* ... same as previous working version ... MathJax call needed for feedback/next step ... */ }
        
        // --- Modify Problem ---
        async function modifyProblem(modificationType) { /* ... same as previous working version ... MathJax call needed for new problem ... */ }

        // --- Chatbot & Tips ---
        function hideProactiveTip() { /* ... same as previous working version ... */ }
        async function triggerProactiveTip() { /* ... same as previous working version ... */ }
        function renderChatMessages() { /* ... same as previous working version ... MathJax call needed for messages ... */ }
        async function sendChatMessage() { /* ... same as previous working version ... */ }

        // --- Paste Image ---
        // Event listener moved to window.onload after pasteZone is defined

        // --- Whiteboard Functionality ---
        function resizeWhiteboardCanvas() { /* ... same as previous working version ... */ }
        function openWhiteboard() { /* ... same as previous working version ... */ }
        function closeWhiteboard() { /* ... same as previous working version ... */ }
        function clearWhiteboard() { /* ... same as previous working version ... */ }
        function getMousePos(canvas, evt) { /* ... same as previous working version ... */ }
        function getTouchPos(canvas, touch) { /* ... same as previous working version ... */ }
        function startDrawing(e) { /* ... same as previous working version ... */ }
        function drawOnWhiteboard(e) { /* ... same as previous working version ... */ }
        function stopDrawing() { /* ... same as previous working version ... */ }
        async function saveWhiteboardAsImage() { /* ... same as previous working version ... */ }
        
        // --- Event Listeners ---
        window.onload = function() {
            // Initialize DOM elements (same as previous working version)
            settingsButton = document.getElementById('settingsButton'); 
            historyButton = document.getElementById('historyButton'); 
            settingsMenu = document.getElementById('settingsMenu'); 
            historyMenu = document.getElementById('historyMenu'); 
            historyPanelContent = document.getElementById('historyPanelContent'); 
            exportCsvButton = document.getElementById('exportCsvButton'); 
            exportJsonButton = document.getElementById('exportJsonButton'); 
            getRecommendationsButton = document.getElementById('getRecommendationsButton'); 
            aiRecommendationsContent = document.getElementById('aiRecommendationsContent'); 
            getHintButton = document.getElementById('getHintButton'); 
            hintDisplay = document.getElementById('hintDisplay'); 
            apiKeyInput = document.getElementById('apiKeyInput');
            saveApiKeyButton = document.getElementById('saveApiKeyButton');
            apiKeyStatus = document.getElementById('apiKeyStatus');
            moduleSelect = document.getElementById('moduleSelect');
            yearSelect = document.getElementById('yearSelect');
            questionSelect = document.getElementById('questionSelect');
            loadProblemButton = document.getElementById('loadProblemButton');
            problemDisplaySection = document.getElementById('problemDisplaySection');
            studentAnswerInput = document.getElementById('studentAnswer');
            checkAnswerButton = document.getElementById('checkAnswerButton'); 
            checkAnswerResultDisplay = document.getElementById('checkAnswerResultDisplay');
            acknowledgeFeedbackButton = document.getElementById('acknowledgeFeedbackButton');
            stepByStepSection = document.getElementById('stepByStepSection');
            currentStepNumberSpan = document.getElementById('currentStepNumber');
            currentSubProblemQuestionDiv = document.getElementById('currentSubProblemQuestion');
            currentSubProblemAnswerInput = document.getElementById('currentSubProblemAnswer');
            checkSubStepButton = document.getElementById('checkSubStepButton');
            imageUploadInput = document.getElementById('imageUpload');
            pasteZone = document.getElementById('pasteZone'); 
            selectedImageName = document.getElementById('selectedImageName');
            simplifyProblemButton = document.getElementById('simplifyProblemButton');
            makeHarderProblemButton = document.getElementById('makeHarderProblemButton');
            loadingIndicator = document.getElementById('loadingIndicator');
            errorMessageDisplay = document.getElementById('errorMessageDisplay');
            errorMessageText = document.getElementById('errorMessageText');
            aiFeedbackDisplay = document.getElementById('aiFeedbackDisplay');
            aiFeedbackContent = document.getElementById('aiFeedbackContent');
            mathBotToggleContainer = document.getElementById('mathBotToggleContainer');
            mathBotToggle = document.getElementById('mathBotToggle');
            proactiveTipBubble = document.getElementById('proactiveTipBubble');
            mathBotContainer = document.getElementById('mathBotContainer');
            closeChatButton = document.getElementById('closeChatButton');
            chatMessagesDisplay = document.getElementById('chatMessagesDisplay');
            chatInput = document.getElementById('chatInput');
            sendChatMessageButton = document.getElementById('sendChatMessageButton');
            openWhiteboardButton = document.getElementById('openWhiteboardButton');
            whiteboardModal = document.getElementById('whiteboardModal');
            drawingBoard = document.getElementById('drawingBoard');
            saveWhiteboardButton = document.getElementById('saveWhiteboardButton');
            clearWhiteboardButton = document.getElementById('clearWhiteboardButton');
            closeWhiteboardButton = document.getElementById('closeWhiteboardButton');

            if (drawingBoard) {
                whiteboardCtx = drawingBoard.getContext('2d');
                 if (!whiteboardCtx) {
                    console.error("Failed to get 2D context for drawing board!");
                }
            } else {
                console.error("Drawing board element not found on load!");
                if(openWhiteboardButton) openWhiteboardButton.disabled = true; 
            }

            loadApiKey(); 
            loadUserHistory(); 
            populateDropdowns(); 
            loadProblemFromSelection(); 

            // Attach event listeners (same as previous working version)
            if(settingsButton) settingsButton.addEventListener('click', toggleSettingsMenu); 
            if(historyButton) historyButton.addEventListener('click', toggleHistoryMenu); 
            if(getHintButton) getHintButton.addEventListener('click', getHint); 
            if(exportCsvButton) exportCsvButton.addEventListener('click', exportAsCsv); 
            if(exportJsonButton) exportJsonButton.addEventListener('click', exportAsJson); 
            if(getRecommendationsButton) getRecommendationsButton.addEventListener('click', getAIRecommendations); 
            
            if(openWhiteboardButton) openWhiteboardButton.addEventListener('click', openWhiteboard);
            if(closeWhiteboardButton) closeWhiteboardButton.addEventListener('click', closeWhiteboard);
            if(clearWhiteboardButton) clearWhiteboardButton.addEventListener('click', clearWhiteboard);
            if(saveWhiteboardButton) saveWhiteboardButton.addEventListener('click', saveWhiteboardAsImage);

            if (drawingBoard) {
                drawingBoard.addEventListener('mousedown', startDrawing);
                drawingBoard.addEventListener('mousemove', drawOnWhiteboard);
                drawingBoard.addEventListener('mouseup', stopDrawing);
                drawingBoard.addEventListener('mouseleave', stopDrawing); 
                drawingBoard.addEventListener('touchstart', startDrawing, { passive: false });
                drawingBoard.addEventListener('touchmove', drawOnWhiteboard, { passive: false });
                drawingBoard.addEventListener('touchend', stopDrawing);
                drawingBoard.addEventListener('touchcancel', stopDrawing);
            }
            
            window.addEventListener('resize', resizeWhiteboardCanvas); 

            if(moduleSelect) moduleSelect.addEventListener('change', () => { populateYears(); populateQuestions(); loadProblemFromSelection(); });
            if(yearSelect) yearSelect.addEventListener('change', () => { populateQuestions(); loadProblemFromSelection(); });
            if(questionSelect) questionSelect.addEventListener('change', loadProblemFromSelection);
            if(loadProblemButton) loadProblemButton.addEventListener('click', loadProblemFromSelection);
            if(checkAnswerButton) checkAnswerButton.addEventListener('click', processStudentInput); 
            if(checkSubStepButton) checkSubStepButton.addEventListener('click', checkSubStepAnswer);
            if(imageUploadInput) imageUploadInput.addEventListener('change', (e) => { 
                if (e.target.files && e.target.files[0]) {
                    if(selectedImageName) selectedImageName.textContent = `拽抓 专: ${e.target.files[0].name}`;
                    if(pasteZone) pasteZone.textContent = '拽抓 专. 转 拽 专 拽.';
                } else {
                    if(selectedImageName) selectedImageName.textContent = '';
                }
            });
            if(simplifyProblemButton) simplifyProblemButton.addEventListener('click', () => modifyProblem('simplify'));
            if(makeHarderProblemButton) makeHarderProblemButton.addEventListener('click', () => modifyProblem('makeHarder'));
            if(saveApiKeyButton) saveApiKeyButton.addEventListener('click', saveApiKey);
            if(mathBotToggle) mathBotToggle.addEventListener('click', () => {
                if(mathBotContainer) mathBotContainer.classList.toggle('expanded');
                if (mathBotContainer && mathBotContainer.classList.contains('expanded')) {
                    hideProactiveTip(); 
                    if(chatInput) chatInput.focus();
                }
            });
            if(closeChatButton) closeChatButton.addEventListener('click', () => {
                if(mathBotContainer) mathBotContainer.classList.remove('expanded');
            });
            if(sendChatMessageButton) sendChatMessageButton.addEventListener('click', sendChatMessage);
            if(chatInput) chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });
            if(pasteZone) pasteZone.addEventListener('paste', function(event) { 
                event.preventDefault(); 
                const items = (event.clipboardData || window.clipboardData).items;
                let imageFile = null;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        imageFile = items[i].getAsFile();
                        break;
                    }
                }
                if (imageFile && imageUploadInput && selectedImageName && pasteZone) {
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(imageFile);
                    imageUploadInput.files = dataTransfer.files;
                    selectedImageName.textContent = `拽抓 拽: ${imageFile.name}`;
                    pasteZone.textContent = '转 拽 爪!';
                    setTimeout(() => { 
                         pasteZone.textContent = ' 拽 爪 住  (Ctrl+V)';
                    }, 3000);
                } else if (selectedImageName && pasteZone) {
                    selectedImageName.textContent = '拽   转 拽转.';
                     pasteZone.textContent = ' 转 转 拽.';
                     setTimeout(() => {
                         pasteZone.textContent = ' 拽 爪 住  (Ctrl+V)';
                    }, 3000);
                }
            });
        };
    </script>
</body>
</html>
